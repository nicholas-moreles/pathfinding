var nextSpinningHeroDirection=Object.freeze({"0,0":[1,1],"0,1":[-1,1],"-1,1":[-1,0],"-1,0":[-1,-1],"-1,-1":[0,-1],"0,-1":[1,-1],"1,-1":[1,0],"1,0":[1,1],"1,1":[0,1]});function Game(B){var e=B;var k;var E=[];var s=[];var d=false;var r=true;var z=Speed.NORMAL;var y;var o;var v=e.getContext("2d");var G=[0,0];var q=0;var m=Map.RANDOM;function n(){v.fillStyle=Colors.CANVAS;v.fillRect(0,0,WIDTH*CELL_SIZE,HEIGHT*CELL_SIZE);v.fillStyle=Colors.WALL;for(var c=0;c<WIDTH;++c){for(var J=0;J<HEIGHT;++J){if(E[J][c]){v.fillRect(c*CELL_SIZE,J*CELL_SIZE,CELL_SIZE,CELL_SIZE)}}}v.fillStyle=Colors.GOAL;v.fillRect(o.x*CELL_SIZE,o.y*CELL_SIZE,CELL_SIZE,CELL_SIZE);v.fillStyle=Colors.HERO;if(s.length===0){if(++q>=8){q=0;G=nextSpinningHeroDirection[String(G)]}}else{G=[s[s.length-1].x-y.x,s[s.length-1].y-y.y]}var I=G[0];var H=G[1];v.beginPath();if(I>0){if(H>0){v.moveTo(y.drawX+OFFSET_DIAG_SMALL,y.drawY);v.lineTo(y.drawX,y.drawY+OFFSET_DIAG_SMALL);v.lineTo(y.drawX+CELL_SIZE,y.drawY+CELL_SIZE)}else{if(H<0){v.moveTo(y.drawX,y.drawY+OFFSET_DIAG_LARGE);v.lineTo(y.drawX+CELL_SIZE,y.drawY);v.lineTo(y.drawX+OFFSET_DIAG_SMALL,y.drawY+CELL_SIZE)}else{v.moveTo(y.drawX,y.drawY+OFFSET_STR_SMALL);v.lineTo(y.drawX,y.drawY+OFFSET_STR_LARGE);v.lineTo(y.drawX+CELL_SIZE,y.drawY+CELL_SIZE/2)}}}else{if(I<0){if(H>0){v.moveTo(y.drawX+OFFSET_DIAG_LARGE,y.drawY);v.lineTo(y.drawX,y.drawY+CELL_SIZE);v.lineTo(y.drawX+CELL_SIZE,y.drawY+OFFSET_DIAG_SMALL)}else{if(H<0){v.moveTo(y.drawX,y.drawY);v.lineTo(y.drawX+CELL_SIZE,y.drawY+OFFSET_DIAG_LARGE);v.lineTo(y.drawX+OFFSET_DIAG_LARGE,y.drawY+CELL_SIZE)}else{v.moveTo(y.drawX+CELL_SIZE,y.drawY+OFFSET_STR_SMALL);v.lineTo(y.drawX+CELL_SIZE,y.drawY+OFFSET_STR_LARGE);v.lineTo(y.drawX,y.drawY+CELL_SIZE/2)}}}else{if(H>0){v.moveTo(y.drawX+OFFSET_STR_SMALL,y.drawY);v.lineTo(y.drawX+OFFSET_STR_LARGE,y.drawY);v.lineTo(y.drawX+CELL_SIZE/2,y.drawY+CELL_SIZE)}else{v.moveTo(y.drawX+OFFSET_STR_SMALL,y.drawY+CELL_SIZE);v.lineTo(y.drawX+OFFSET_STR_LARGE,y.drawY+CELL_SIZE);v.lineTo(y.drawX+CELL_SIZE/2,y.drawY)}}}v.closePath();v.fill()}function w(c,H){if(inBoundsAndNotWall(c,H,E)&&!(y.x===c&&y.y===H)&&!(o.x===c&&o.y===H)&&(s.length===0||!(s[s.length-1].x===c&&s[s.length-1].y===H))){p();E[H][c]=true;n()}}function A(c,H){if(inBounds(c,H)&&E[H][c]){p();E[H][c]=false;n()}}function t(c,H){if(inBoundsAndNotWall(c,H,E)&&!(y.x===c&&y.y===H)&&!(o.x===c&&o.y===H)){p();y=new Hero(c,H);s=aStar(y,o,E,r);n()}}function j(c,H){if(inBoundsAndNotWall(c,H,E)&&!(y.x===c&&y.y===H)&&!(o.x===c&&o.y===H)){p();o=new Position(c,H);s=aStar(y,o,E,r);n()}}function l(H){if(H.length>0){var c=H.pop();y.x=c.x;y.y=c.y}}function h(){d=true;s=aStar(y,o,E,r);$("#start-pause-button").removeClass("btn-success").addClass("btn-danger");$("#start-pause-button").html("Pause");var c=+new Date;var I=y.drawX;var H=y.drawY;var M=s.length>0?s[s.length-1]:y;var O=M.x*CELL_SIZE;var L=M.y*CELL_SIZE;var K=M.x-y.x;var J=M.y-y.y;var N=(K===0||J===0)?z[0]:z[1];k=setInterval(function(){var P=+new Date;var Q=P-c;if(Q>N){Q-=N;c=P;l(s);I=y.drawX;H=y.drawY;if(s.length>0){M=s[s.length-1];O=M.x*CELL_SIZE;L=M.y*CELL_SIZE;K=M.x-y.x;J=M.y-y.y;N=(K===0||J===0)?z[0]:z[1]}}y.drawX=I+(Q/N)*(O-I);y.drawY=H+(Q/N)*(L-H);n()},10)}function i(){d=false;$("#start-pause-button").removeClass("btn-danger").addClass("btn-success");$("#start-pause-button").html("Start");clearInterval(k)}function x(){for(var c=0;c<WIDTH;++c){var H=[];for(var I=0;I<HEIGHT;++I){H.push(false)}E.push(H)}D()}function D(){switch(m){case Map.SPIRAL:b(new Hero(0,0),new Position(19,19),getMapFromFile("spiral.txt"));break;case Map.EMPTY:b(new Hero(0,0),new Position(WIDTH-1,HEIGHT-1),NO_WALLS);break;default:b(new Hero(0,0),new Position(WIDTH-1,HEIGHT-1),getRandomMap());break}}function F(c){m=c;D()}function b(I,H,J){p();y=I;o=H;for(var c=0;c<WIDTH;++c){for(var K=0;K<HEIGHT;++K){E[K][c]=J[K][c]}}s=aStar(y,o,E,r);n()}function g(){var c=p();r=!r;C(c);return r}function f(c){switch(c){case Selected.SLOW_SPEED:z=Speed.SLOW;break;case Selected.NORMAL_SPEED:z=Speed.NORMAL;break;case Selected.FAST_SPEED:z=Speed.FAST;break}}function a(){return d}function p(){if(a()){i();return true}return false}function C(c){if(c){h()}}function u(){if(d){i()}else{h()}}return{init:x,addWall:w,removeWall:A,moveHero:t,moveGoal:j,reset:D,setMap:F,isRunning:a,toggleDiag:g,setSpeed:f,toggle:u,loadMap:b}};
